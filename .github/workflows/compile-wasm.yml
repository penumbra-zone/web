name: Compile WASM
on:
  workflow_call:
  workflow_dispatch:

jobs:
  wasm:
    runs-on: buildjet-16vcpu-ubuntu-2204
    steps:
      - uses: actions/checkout@v4

      - id: compiled
        uses: buildjet/cache@v4
        with:
          path: .turbo
          key: ${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.ref }}-${{ github.sha }}-compiled
          restore-keys: ${{ hashFiles('**/Cargo.lock') }}

      - name: setup nix
        uses: ./.github/actions/setup-nix
        # Optional: override default parameters
        # with:
        #   backend: 'github'

      - name: compile wasm code
        run: nix develop --command just wasm

      - name: Verify no unexpected file changes (like cargo.lock change)
        run: git diff --exit-code
        working-directory: packages/wasm/crate

      - name: dump rust dependencies for debugging, only on failure
        run: nix develop --command cargo tree --invert penumbra-wasm --edges features
        if: failure()
        working-directory: packages/wasm/crate
